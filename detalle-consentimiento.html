<!DOCTYPE html>
<script>
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('consultorAuth') !== 'true') {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('logoutButton').addEventListener('click', () => {
                sessionStorage.removeItem('consultorAuth');
                // --- CAMBIO: Limpiamos también la llave secreta ---
                sessionStorage.removeItem('apiSecret');
                window.location.href = 'login.html';
            });
            fetchReport();
        });

        async function fetchReport() {
            const loadingDiv = document.getElementById('loading');
            const reportContentDiv = document.getElementById('reportContent');
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            try {
                // --- CAMBIO CLAVE: Leer y enviar la llave secreta ---
                const secret = sessionStorage.getItem('apiSecret');
                if (!secret) {
                    throw new Error('No se encontró el pase de seguridad. Inicia sesión de nuevo.');
                }
                const response = await fetch(`/api/get-consentimiento-individual?id=${id}`, {
                    headers: { 'X-Auth-Secret': secret }
                });
                // --- FIN DEL CAMBIO ---

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message);
                }
                const reporte = await response.json();
                
                displayReport(reporte); // Tu función displayReport va aquí

                loadingDiv.classList.add('hidden');
                reportContentDiv.classList.remove('hidden');

            } catch (error) {
                console.error("Error al cargar el reporte:", error);
                loadingDiv.innerHTML = `<h1 class="text-3xl text-red-600">Error: ${error.message}</h1>`;
            }
        }
        
        // Aquí va la función displayReport(reporte) que ya funciona.
        // function displayReport(reporte) { ... }
    </script>
</body>
</html>
