<!DOCTYPE html>
<script>
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('consultorAuth') !== 'true') {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('logoutButton').addEventListener('click', () => {
                sessionStorage.removeItem('consultorAuth');
                // --- CAMBIO: Limpiamos también la llave secreta ---
                sessionStorage.removeItem('apiSecret');
                window.location.href = 'login.html';
            });
            fetchConsentimientos();
        });

        async function fetchConsentimientos() {
            const loadingDiv = document.getElementById('loading');
            // ...
            try {
                // --- CAMBIO CLAVE: Leer y enviar la llave secreta ---
                const secret = sessionStorage.getItem('apiSecret');
                if (!secret) throw new Error('No autenticado');
                const response = await fetch('/api/get-consentimientos', {
                    headers: { 'X-Auth-Secret': secret }
                });
                // --- FIN DEL CAMBIO ---

                if (!response.ok) throw new Error('Error de conexión.');
                const consentimientos = await response.json();
                // ... resto de la lógica para mostrar la lista
            } catch (error) {
                loadingDiv.innerHTML = 'Error al cargar. Por favor, inicia sesión de nuevo.';
            }
        }

        async function deleteConsent(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este consentimiento?')) return;
            try {
                // --- CAMBIO CLAVE: Leer y enviar la llave secreta ---
                const secret = sessionStorage.getItem('apiSecret');
                if (!secret) throw new Error('No autenticado');
                const response = await fetch(`/api/eliminar-consentimiento?id=${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Auth-Secret': secret }
                });
                // --- FIN DEL CAMBIO ---

                if (response.ok) {
                    // ... Lógica para eliminar el item de la vista ...
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.message}`);
                }
            } catch (error) {
                alert('Error de conexión. Por favor, inicia sesión de nuevo.');
            }
        }
    </script>
</body>
</html>
